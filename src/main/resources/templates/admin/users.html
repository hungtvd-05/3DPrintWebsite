<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/base::layout(~{::section})}">>
<head>
    <meta charset="UTF-8">
    <title>Title</title>

</head>
<body>
<section>
    <!--    <link rel="stylesheet" th:href="@{/css/table.css}">-->

    <style>
        .tag-input-wrapper {
            position: relative;
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
    </style>

    <div class="container-xl">
        <h4 class="text-center">Users</h4>
        <hr>
        <th:block th:if="${session.succMsg}">
            <p class="text-success fw-bold text-center">[[${session.succMsg}]]</p>
            <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <th:block th:if="${session.errorMsg}">
            <p class="text-danger fw-bold text-center">[[${session.errorMsg}]]</p>
            <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <div class="tag-input-wrapper mb-3">
            <input type="text"
                   class="form-control"
                   id="input-sugg"
                   placeholder="Tìm kiếm sản phẩm..."
                   autocomplete="off"
                   th:value="${search}"/>
            <div class="suggestion-list" style="display: none;">
            </div>
        </div>
        <th:block th:if="${search == true && users.size() == 0}">
            <p class="fs-4 text-center">Không có người dùng nào phù hợp yêu cầu tìm kiếm!</p>
        </th:block>
        <th:block th:if="${search == false && users.size() == 0}">
            <p class="fs-4 text-center">Không có tài khoản nào!</p>
        </th:block>
        <th:block th:if="${users.size() > 0}">
            <table class="table table-bordered mb-4">
                <thead>
                <tr>
                    <th scope="col">Tên</th>
                    <th scope="col" class="text-end">Trạng thái</th>
                </tr>
                </thead>
                <tbody class="danhsach">
                <tr th:each="u,c:${users}">
                    <td data-label="Tên">
                        [[${u.getFullName()}]]
                        <br>
                        [[${u.getEmail()}]]
                        <br>
                        [[${u.getPhoneNumber()}]]
                    </td>
                    <td data-label="Trạng thái" class="text-end">
                        <span class="status" th:userId="${u.userId}" th:text="${u.isEnable ? 'Confirm' : 'No'}"></span>
                        <a href="javascript:void(0)"
                           class="btn btn-primary btn-sm update-status-btn"
                           th:data-id="${u.userId}"
                           data-status="true"
                           data-role="ROLE_USER">
                            Confirm
                        </a>
                        <a href="javascript:void(0)"
                           class="btn btn-danger btn-sm update-status-btn"
                           th:data-id="${u.userId}"
                           data-status="false"
                           data-role="ROLE_USER">
                            No
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center" th:if="${search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link" th:href="@{'/admin/users?page=' + ${page}}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link" th:href="@{'/admin/users?page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" aria-label="Next" th:href="@{'/admin/users?page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center" th:if="${!search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link"
                           th:href="@{'/admin/users?search=' + ${search} + '&page=' + ${page}}"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link"
                           th:href="@{'/admin/users?search=' + ${search} + '&page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" aria-label="Next"
                           th:href="@{'/admin/users?search=' + ${search} + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <script th:inline="javascript">
                const input = document.getElementById('input-sugg');
                const suggestionList = document.querySelector('.suggestion-list');
                let availableKeywords = new Set();

                // Lấy danh sách keywords từ Thymeleaf (là Set<String>)
                const initialKeywords = [[${keywords}]];

                // Thêm tất cả keywords vào Set để tìm kiếm
                initialKeywords.forEach(keyword => {
                    if (keyword && keyword.trim()) {
                        availableKeywords.add(keyword.toLowerCase());
                    }
                });

                // Xử lý input
                input.addEventListener('input', function () {
                    const value = this.value.trim().toLowerCase();
                    updateSuggestions(value);
                });

                // Xử lý phím Enter và Escape
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSearchInput(this.value.trim());
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                });

                // Ẩn gợi ý khi click ra ngoài
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.tag-input-wrapper')) {
                        hideSuggestions();
                    }
                });

                function updateSuggestions(value) {
                    if (!value) {
                        hideSuggestions();
                        return;
                    }

                    const matches = [];
                    availableKeywords.forEach(keyword => {
                        if (keyword.includes(value)) {
                            matches.push(keyword);
                        }
                    });

                    if (matches.length > 0) {
                        matches.sort((a, b) => {
                            const aStartsWith = a.startsWith(value);
                            const bStartsWith = b.startsWith(value);
                            if (aStartsWith && !bStartsWith) return -1;
                            if (!aStartsWith && bStartsWith) return 1;
                            return a.length - b.length;
                        });

                        showSuggestions(matches.slice(0, 8), value);
                    } else {
                        hideSuggestions();
                    }
                }

                function showSuggestions(matches, inputValue) {
                    suggestionList.innerHTML = '';

                    matches.forEach(keyword => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';

                        // Highlight text matching
                        const matchIndex = keyword.toLowerCase().indexOf(inputValue.toLowerCase());
                        const beforeMatch = keyword.slice(0, matchIndex);
                        const match = keyword.slice(matchIndex, matchIndex + inputValue.length);
                        const afterMatch = keyword.slice(matchIndex + inputValue.length);

                        div.innerHTML = `${beforeMatch}<strong>${match}</strong>${afterMatch}`;

                        div.addEventListener('click', () => {
                            handleSearchInput(keyword);
                            input.value = keyword;
                            hideSuggestions();
                        });

                        suggestionList.appendChild(div);
                    });

                    suggestionList.style.display = 'block';
                }

                function hideSuggestions() {
                    suggestionList.style.display = 'none';
                }

                function handleSearchInput(value) {
                    if (!value) return;

                    // Thực hiện tìm kiếm với keyword
                    window.location.href = `/admin/users?search=${encodeURIComponent(value)}`;
                }
            </script>

            <script>
                $(document).ready(function () {

                    $('.update-status-btn').click(function () {
                        var btn = $(this);
                        var userId = btn.data('id');
                        var status = btn.data('status');

                        var statusSpan = $(`span.status[userId="${userId}"]`);

                        const formData = new FormData();
                        formData.append('userId', userId);
                        formData.append('status', status);

                        fetch('/admin/updateSts', {
                            method: 'POST',
                            body: formData,
                            headers: {'X-Requested-With': 'XMLHttpRequest'}
                        }).then(response => {
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.json();
                        }).then(data => {
                            if (data.success && data.statusName) {
                                statusSpan.fadeOut(200, function () {
                                    $(this).text(data.statusName).fadeIn(200);
                                });
                            }
                        })

                    });
                })
            </script>
        </th:block>
    </div>
</section>
</body>
</html>