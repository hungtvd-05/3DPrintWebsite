<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/base::layout(~{::section})}">>
<head>
    <meta charset="UTF-8">
    <title>Title</title>

</head>
<body>
<section>

    <style>
        .tag-input-wrapper {
            position: relative;
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 45px;
        }

        .tag {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .remove-tag {
            cursor: pointer;
            color: #dc3545;
        }
    </style>

    <link rel="stylesheet" th:href="@{/css/table.css}">

    <div class="content1">
        <h4 class="text-center">Bài viết</h4>
        <hr>
        <th:block th:if="${session.succMsg}">
            <p class="text-success fw-bold text-center">[[${session.succMsg}]]</p>
            <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>
        <th:block th:if="${session.errorMsg}">
            <p class="text-danger fw-bold  text-center">[[${session.errorMsg}]]</p>
            <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>
        <form action="/admin/search-product" method="get">
            <div class="row">
                <div class="col-md pb-2 tag-input-wrapper">
                    <input type="text"
                           class="form-control"
                           id="input-sugg"
                           placeholder="Tìm kiếm bài viết..."
                           autocomplete="off"
                           th:value="${search}"/>
                    <div class="suggestion-list" style="display: none;">
                        <!-- Suggestions sẽ được thêm vào đây bằng JavaScript -->
                    </div>
                </div>
                <div class="col-md pb-2">
                    <div class="row">
                        <div class="col">
                            <select class="form-control" id="sortSelect" onchange="updateLocation();">
                                <option th:selected="${sorted == ''}" value="">Mặc định</option>
                                <option th:selected="${sorted == 'az'}" value="az">Từ A->Z</option>
                                <option th:selected="${sorted == 'za'}" value="za">Từ Z->A</option>
                                <option th:selected="${sorted == 'new'}" value="new">Bài viết mới</option>
                                <option th:selected="${sorted == 'old'}" value="old">Bài viết cũ</option>
                            </select>
                        </div>
                        <div class="col">
                            <a href="/admin/add-blog" class="btn btn-success col mb-2 w-100">Thêm bài viết</a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <th:block th:if="${!blogs.isEmpty()}">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th scope="col">Tiêu đề</th>
                    <th scope="col">Ngày tạo</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col"></th>
                </tr>
                </thead>
                <tbody class="danhsach">
                <tr th:each="blog:${blogs}">
                    <td data-label="Tên" th:utext="${blog.title}" class="fs-5 dulieu"></td>
                    <td data-label="Ngày tạo" th:text="${#temporals.format(blog.createAt, 'HH:mm - dd/MM/yyyy')}"
                        class="fs-5 dulieu"></td>
                    <td data-label="Trạng thái" th:text="${blog.status ? 'Hiện' : 'Ẩn'}" class="fs-5 dulieu"></td>
                    <td class="text-end">
                        <a th:href="@{'/admin/edit-blog:' + ${blog.id}}" class="btn btn-primary btn-sm"><i
                                class="fa-solid fa-pen-to-square"></i> Sửa</a>
                        <a href="javascript:void(0)"
                           class="btn btn-danger btn-sm delete-btn"
                           th:data-id="${blog.id}">
                            <i class="fa-solid fa-trash"></i>Xóa
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center" th:if="${search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link" th:if="${sorted == ''}" th:href="@{'/admin/blogs?page=' + ${page}}"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/admin/blogs?sorted=' + ${sorted} + '&page=' + ${page}}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/admin/blogs?page=' + ${i}}">[[${i}]]</a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/admin/blogs?sorted=' + ${sorted} + '&page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" th:if="${sorted == ''}" aria-label="Next"
                           th:href="@{'/admin/blogs?page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}" aria-label="Next"
                           th:href="@{'/admin/blogs?sorted=' + ${sorted} + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center"
                 th:if="${!search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/admin/blogs?search=' + ${search}  + '&page=' + ${page}}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/admin/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${page}}"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/admin/blogs?search=' + ${search} + '&page=' + ${i}}">[[${i}]]</a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/admin/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" th:if="${sorted == ''}" aria-label="Next"
                           th:href="@{'/admin/blogs?search=' + ${search}  + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}" aria-label="Next"
                           th:href="@{'/admin/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

        </th:block>
    </div>

    <script th:inline="javascript">
        const input = document.getElementById('input-sugg');
        const suggestionList = document.querySelector('.suggestion-list');
        let availableProducts = new Map();

        // Lấy danh sách sản phẩm từ API hoặc Thymeleaf
        const initialProducts = /*[[${blogsSearch}]]*/ [];

        initialProducts.forEach(product => {
            availableProducts.set(product.title.toLowerCase(), {id: product.id, name: product.title});
        });

        // Xử lý input
        input.addEventListener('input', function () {
            const value = this.value.trim().toLowerCase();
            updateSuggestions(value);
        });

        // Xử lý phím Enter và Escape
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearchInput(this.value.trim());
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // Ẩn gợi ý khi click ra ngoài
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.tag-input-wrapper')) {
                hideSuggestions();
            }
        });

        function updateSuggestions(value) {
            if (!value) {
                hideSuggestions();
                return;
            }

            const matches = [];
            availableProducts.forEach((product, key) => {
                if (key.includes(value)) {
                    matches.push(product);
                }
            });

            if (matches.length > 0) {
                showSuggestions(matches, value);
            } else {
                hideSuggestions();
            }
        }

        function showSuggestions(matches, inputValue) {
            suggestionList.innerHTML = '';
            matches.forEach(product => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                const matchIndex = product.name.toLowerCase().indexOf(inputValue.toLowerCase());
                const beforeMatch = product.name.slice(0, matchIndex);
                const match = product.name.slice(matchIndex, matchIndex + inputValue.length);
                const afterMatch = product.name.slice(matchIndex + inputValue.length);
                div.innerHTML = `${beforeMatch}<strong>${match}</strong>${afterMatch}`;

                div.addEventListener('click', () => {
                    // Chuyển hướng đến trang chi tiết sản phẩm hoặc thực hiện tìm kiếm
                    handleSearchInput(product.name);
                    input.value = '';
                    hideSuggestions();
                });

                suggestionList.appendChild(div);
            });

            suggestionList.style.display = 'block';
        }

        function hideSuggestions() {
            suggestionList.style.display = 'none';
        }

        function handleSearchInput(value) {
            // if (!value) return;

            const lowercaseValue = value.toLowerCase();
            if (availableProducts.has(lowercaseValue)) {
                const product = availableProducts.get(lowercaseValue);
                // Chuyển hướng đến trang chi tiết sản phẩm
                window.location.href = `/admin/edit-blog:${product.id}`;
            } else {
                // Thực hiện tìm kiếm với giá trị nhập vào
                window.location.href = `/admin/blogs?search=${encodeURIComponent(value)}`;
            }
        }

        function updateLocation() {
            var sort = document.getElementById('sortSelect').value;
            var search = document.getElementById('input-sugg').value;
            var newUrl = '/admin/blogs';

            // Tạo danh sách tham số URL
            var params = [];

            // Thêm tham số tìm kiếm nếu có
            if (search) {
                params.push('search=' + encodeURIComponent(search));
            }

            // Thêm tham số sắp xếp nếu có
            if (sort) {
                params.push('sorted=' + encodeURIComponent(sort));
            }

            // Tạo URL đầy đủ
            if (params.length > 0) {
                newUrl += '?' + params.join('&');
            }

            // Chuyển hướng đến URL mới
            window.location.href = newUrl;
        }

        $(document).ready(function () {

            $('.delete-btn').click(function () {
                var btn = $(this);
                var id = btn.data('id');
                var row = btn.closest('tr');

                $.ajax({
                    url: '/admin/delete-blog',
                    method: 'GET',
                    data: {
                        id: id
                    },
                    success: function (response) {
                        if (response && response.isDelete) {
                            row.fadeOut(200, function () {
                                $(this).remove();
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading revenue data:', error);
                        $("#error-message").show().text('Không thể tải dữ liệu. Vui lòng thử lại sau.');
                    }
                });

            });
        })

    </script>

</section>
</body>
</html>