<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::layout(~{::section})}">>
<head>
    <meta charset="UTF-8">
    <title>Title</title>

</head>
<body>
<section>

    <style>
        .tag-input-wrapper {
            position: relative;
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 45px;
        }

        .tag {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .remove-tag {
            cursor: pointer;
            color: #dc3545;
        }
    </style>

    <div class="container-xl">
        <h4 class="text-center my-3">Bài viết</h4>
        <div class="col-md tag-input-wrapper">
            <input type="text"
                   class="form-control"
                   id="input-sugg"
                   placeholder="Tìm kiếm bài viết..."
                   autocomplete="off"
                   th:value="${search}"/>
            <div class="suggestion-list" style="display: none;">
                <!-- Suggestions sẽ được thêm vào đây bằng JavaScript -->
            </div>
        </div>

        <div class="d-flex gap-2 flex-wrap my-3">
            <button type="button" class="btn sort-btn" data-sort=""
                    th:classappend="${sorted == '' ? 'btn-primary' : 'btn-outline-dark'}">
                Mặc định
            </button>
            <button type="button" class="btn sort-btn" data-sort="az"
                    th:classappend="${sorted == 'az' ? 'btn-primary' : 'btn-outline-dark'}">
                Từ A->Z
            </button>
            <button type="button" class="btn sort-btn" data-sort="za"
                    th:classappend="${sorted == 'za' ? 'btn-primary' : 'btn-outline-dark'}">
                Từ Z->A
            </button>
            <button type="button" class="btn sort-btn" data-sort="new"
                    th:classappend="${sorted == 'new' ? 'btn-primary' : 'btn-outline-dark'}">
                Bài viết mới
            </button>
            <button type="button" class="btn sort-btn" data-sort="old"
                    th:classappend="${sorted == 'old' ? 'btn-primary' : 'btn-outline-dark'}">
                Bài viết cũ
            </button>
        </div>
        <th:block th:if="${!blogs.isEmpty()}">
            <a class="text-dark" th:href="${'/blog:' + blog.id}" th:each="blog : ${blogs}">
                <h4 th:text="${blog.title}"></h4>
                <p th:text="${'Ngày tạo: ' + #temporals.format(blog.createAt, 'HH:mm - dd/MM/yyyy')}"></p>
                <div class="content-preview" th:utext="${#strings.length(blog.content) > 200 ? #strings.abbreviate(#strings.replace(blog.content, '<[^>]*>', ''), 200) : #strings.replace(blog.content, '<[^>]*>', '')}"></div>
                <hr>
            </a>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center" th:if="${search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link" th:if="${sorted == ''}" th:href="@{'/blogs?page=' + ${page}}"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/blogs?sorted=' + ${sorted} + '&page=' + ${page}}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/blogs?page=' + ${i}}">[[${i}]]</a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/blogs?sorted=' + ${sorted} + '&page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" th:if="${sorted == ''}" aria-label="Next"
                           th:href="@{'/blogs?page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}" aria-label="Next"
                           th:href="@{'/blogs?sorted=' + ${sorted} + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <nav aria-label="Page navigation example" class="d-flex justify-content-center"
                 th:if="${!search.isEmpty()}">
                <ul class="pagination">
                    <li class="page-item" th:unless="${isFirst}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/blogs?search=' + ${search}  + '&page=' + ${page}}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${page}}"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="i:${#numbers.sequence(1, totalPages)}" class="page-item"
                        th:classappend="${page + 1 == i ? 'active':''}">
                        <a class="page-link" th:if="${sorted == ''}"
                           th:href="@{'/blogs?search=' + ${search} + '&page=' + ${i}}">[[${i}]]</a>
                        <a class="page-link" th:unless="${sorted == ''}"
                           th:href="@{'/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${i}}">[[${i}]]</a>
                    </li>
                    <li class="page-item" th:unless="${isLast}">
                        <a class="page-link" th:if="${sorted == ''}" aria-label="Next"
                           th:href="@{'/blogs?search=' + ${search}  + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                        <a class="page-link" th:unless="${sorted == ''}" aria-label="Next"
                           th:href="@{'/blogs?search=' + ${search}  + '&sorted=' + ${sorted} + '&page=' + ${page + 2}}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

        </th:block>
    </div>


    <script th:inline="javascript">
        const input = document.getElementById('input-sugg');
        const suggestionList = document.querySelector('.suggestion-list');
        let availableProducts = new Map();

        // Lấy danh sách sản phẩm từ API hoặc Thymeleaf
        const initialProducts = /*[[${blogsSearch}]]*/ [];

        initialProducts.forEach(product => {
            availableProducts.set(product.title.toLowerCase(), {id: product.id, name: product.title});
        });

        // Xử lý input
        input.addEventListener('input', function () {
            const value = this.value.trim().toLowerCase();
            updateSuggestions(value);
        });

        // Xử lý phím Enter và Escape
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearchInput(this.value.trim());
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // Ẩn gợi ý khi click ra ngoài
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.tag-input-wrapper')) {
                hideSuggestions();
            }
        });

        function updateSuggestions(value) {
            if (!value) {
                hideSuggestions();
                return;
            }

            const matches = [];
            availableProducts.forEach((product, key) => {
                if (key.includes(value)) {
                    matches.push(product);
                }
            });

            if (matches.length > 0) {
                showSuggestions(matches, value);
            } else {
                hideSuggestions();
            }
        }

        function showSuggestions(matches, inputValue) {
            suggestionList.innerHTML = '';
            matches.forEach(product => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                const matchIndex = product.name.toLowerCase().indexOf(inputValue.toLowerCase());
                const beforeMatch = product.name.slice(0, matchIndex);
                const match = product.name.slice(matchIndex, matchIndex + inputValue.length);
                const afterMatch = product.name.slice(matchIndex + inputValue.length);
                div.innerHTML = `${beforeMatch}<strong>${match}</strong>${afterMatch}`;

                div.addEventListener('click', () => {
                    // Chuyển hướng đến trang chi tiết sản phẩm hoặc thực hiện tìm kiếm
                    handleSearchInput(product.name);
                    input.value = '';
                    hideSuggestions();
                });

                suggestionList.appendChild(div);
            });

            suggestionList.style.display = 'block';
        }

        function hideSuggestions() {
            suggestionList.style.display = 'none';
        }

        function handleSearchInput(value) {
            // if (!value) return;

            const lowercaseValue = value.toLowerCase();
            if (availableProducts.has(lowercaseValue)) {
                const product = availableProducts.get(lowercaseValue);
                // Chuyển hướng đến trang chi tiết sản phẩm
                window.location.href = `/blog:${product.id}`;
            } else {
                // Thực hiện tìm kiếm với giá trị nhập vào
                window.location.href = `/blogs?search=${encodeURIComponent(value)}`;
            }
        }

        document.querySelectorAll('.sort-btn').forEach(button => {
            button.addEventListener('click', function () {
                const sortValue = this.getAttribute('data-sort');
                const searchValue = document.getElementById('input-sugg').value;

                // Update button styles
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.className = 'btn sort-btn btn-outline-dark';
                });
                this.className = 'btn sort-btn btn-primary';

                // Build URL
                let newUrl = '/blogs';
                const params = [];

                if (searchValue) {
                    params.push('search=' + encodeURIComponent(searchValue));
                }

                if (sortValue) {
                    params.push('sorted=' + encodeURIComponent(sortValue));
                }

                if (params.length > 0) {
                    newUrl += '?' + params.join('&');
                }

                window.location.href = newUrl;
            });
        });


    </script>

</section>
</body>
</html>